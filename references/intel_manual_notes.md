# ğŸ“– Intel æ‰‹å†Šé‡é»æ‘˜è¦

## Volume 3A - ç³»çµ±ç¨‹å¼è¨­è¨ˆæŒ‡å—

### Chapter 2: System Architecture Overview

#### 2.1 ä½œæ¥­ç³»çµ±èˆ‡åŸ·è¡Œç’°å¢ƒæ¦‚è¿°

x86 æ¶æ§‹æä¾›ä»¥ä¸‹ç³»çµ±ç´šåŠŸèƒ½ï¼š
- **è¨˜æ†¶é«”ç®¡ç†**ï¼šåˆ†æ®µå’Œåˆ†é æ©Ÿåˆ¶
- **ä¿è­·æ©Ÿåˆ¶**ï¼š4 å€‹ç‰¹æ¬Šç´šåˆ¥ (Ring 0-3)
- **å¤šå·¥æ”¯æ´**ï¼šä»»å‹™åˆ‡æ›å’Œ TSS
- **ä¸­æ–·å’Œç•°å¸¸è™•ç†**ï¼šIDT å’Œä¸­æ–·æ©Ÿåˆ¶
- **I/O**ï¼šI/O ç«¯å£å’Œè¨˜æ†¶é«”æ˜ å°„ I/O

#### 2.2 æ§åˆ¶æš«å­˜å™¨

| æš«å­˜å™¨ | é‡è¦ä½å…ƒ | èªªæ˜ |
|--------|----------|------|
| CR0 | PE (ä½å…ƒ 0) | ä¿è­·æ¨¡å¼å•Ÿç”¨ |
| CR0 | PG (ä½å…ƒ 31) | åˆ†é å•Ÿç”¨ |
| CR2 | - | é é¢éŒ¯èª¤ç·šæ€§ä½å€ |
| CR3 | - | é ç›®éŒ„åŸºå€ |
| CR4 | PAE (ä½å…ƒ 5) | å¯¦é«”ä½å€æ“´å±• |
| CR4 | PSE (ä½å…ƒ 4) | é é¢å¤§å°æ“´å±• |

---

### Chapter 3: Protected-Mode Memory Management

#### 3.1 åˆ†æ®µæ¦‚è¿°

```
é‚è¼¯ä½å€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  ç·šæ€§ä½å€
         æ®µé¸æ“‡å­ + åç§»é‡
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ®µæè¿°ç¬¦    â”‚
        â”‚   (GDT/LDT)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 æ®µé¸æ“‡å­

```
15                              3  2  1  0
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”
â”‚          Index (13 bits)         â”‚TIâ”‚RPL â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”˜

TI: Table Indicator (0=GDT, 1=LDT)
RPL: Requested Privilege Level
```

#### 3.3 æ®µæè¿°ç¬¦

```c
struct segment_descriptor {
    uint16_t limit_low;      // Limit 15:0
    uint16_t base_low;       // Base 15:0
    uint8_t  base_middle;    // Base 23:16
    uint8_t  access;         // Access byte
    uint8_t  granularity;    // Granularity and Limit 19:16
    uint8_t  base_high;      // Base 31:24
} __attribute__((packed));
```

Access Byte:
```
7   6   5   4   3   2   1   0
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ P â”‚  DPL  â”‚ S â”‚ E â”‚DC â”‚RW â”‚ A â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
```

---

### Chapter 4: Paging

#### 4.1 åˆ†é æ¨¡å¼

| æ¨¡å¼ | CR0.PG | CR4.PAE | é é¢å¤§å° | ç‰©ç†ä½å€å¯¬åº¦ |
|------|--------|---------|----------|--------------|
| ç„¡åˆ†é  | 0 | - | - | - |
| 32-bit | 1 | 0 | 4KB/4MB | 32-bit/40-bit |
| PAE | 1 | 1 | 4KB/2MB | 52-bit |

#### 4.2 32-bit åˆ†é 

```
                    ç·šæ€§ä½å€ (32-bit)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Directory    â”‚    Table      â”‚    Offset     â”‚
â”‚   (10 bits)   â”‚   (10 bits)   â”‚   (12 bits)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
        â”‚   â”‚                           â”‚
        â–¼   â–¼                           â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
   â”‚Page        â”‚â”€â”€â”€â–ºâ”‚Page        â”‚     â”‚
   â”‚Directory   â”‚    â”‚Table       â”‚     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
                           â”‚            â”‚
                           â–¼            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
                    â”‚  Physical  â”‚â—„â”€â”€â”€â”€â”€â”˜
                    â”‚    Page    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3 é è¡¨é …æ ¼å¼

```
31                              12 11          0
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Physical Frame Number      â”‚  Flags   â”‚
â”‚            (20 bits)              â”‚(12 bits) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Flags:
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”
â”‚ G â”‚ S â”‚ 0 â”‚ A â”‚PCDâ”‚PWTâ”‚U/Sâ”‚R/Wâ”‚ P â”‚AVLâ”‚AVLâ”‚AVLâ”‚
â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜
 11  10   9   8   7   6   5   4   3   2   1   0
```

---

### Chapter 6: Interrupt and Exception Handling

#### 6.1 ç•°å¸¸åˆ†é¡

| é¡å‹ | æè¿° | ç¯„ä¾‹ |
|------|------|------|
| Fault | å¯ä¿®æ­£ï¼Œè¿”å›åˆ°åŸæŒ‡ä»¤ | #PF, #GP |
| Trap | è¿”å›åˆ°ä¸‹ä¸€æ¢æŒ‡ä»¤ | #BP, #OF |
| Abort | åš´é‡éŒ¯èª¤ï¼Œç„¡æ³•ç¹¼çºŒ | #DF, #MC |

#### 6.2 IDT é–˜é“æè¿°ç¬¦

```c
struct idt_gate {
    uint16_t offset_low;     // Offset 15:0
    uint16_t selector;       // Segment selector
    uint8_t  zero;           // Must be 0
    uint8_t  type_attr;      // Type and attributes
    uint16_t offset_high;    // Offset 31:16
} __attribute__((packed));

// Type attributes:
// 0x8E = 32-bit interrupt gate (P=1, DPL=0, Type=0xE)
// 0xEE = 32-bit interrupt gate (P=1, DPL=3, Type=0xE)
// 0x8F = 32-bit trap gate (P=1, DPL=0, Type=0xF)
```

#### 6.3 ä¸­æ–·è™•ç†æµç¨‹

1. å¦‚æœç™¼ç”Ÿç‰¹æ¬Šç´šåˆ¥è®ŠåŒ–ï¼š
   - å¾ TSS è¼‰å…¥æ–°çš„ SS å’Œ ESP
   - å°‡èˆŠçš„ SS å’Œ ESP æ¨å…¥æ–°å †ç–Š

2. æ¨å…¥ EFLAGS

3. æ¨å…¥ CS å’Œ EIP

4. å¦‚æœéœ€è¦ï¼Œæ¨å…¥éŒ¯èª¤ç¢¼

5. å¾ IDT è¼‰å…¥æ–°çš„ CS å’Œ EIP

---

## å¸¸ç”¨æŒ‡ä»¤é€ŸæŸ¥

| æŒ‡ä»¤ | æè¿° |
|------|------|
| LGDT | è¼‰å…¥ GDT æš«å­˜å™¨ |
| LIDT | è¼‰å…¥ IDT æš«å­˜å™¨ |
| LTR | è¼‰å…¥ä»»å‹™æš«å­˜å™¨ |
| MOV CRn | è®€å¯«æ§åˆ¶æš«å­˜å™¨ |
| IRET | ä¸­æ–·è¿”å› |
| CLI | æ¸…é™¤ä¸­æ–·æ¨™èªŒ |
| STI | è¨­ç½®ä¸­æ–·æ¨™èªŒ |
| HLT | åœæ­¢ CPU ç›´åˆ°ä¸­æ–· |
| IN/OUT | I/O ç«¯å£å­˜å– |
| INVLPG | ä½¿ TLB é …ç›®ç„¡æ•ˆ |
| WBINVD | å¯«å›ä¸¦ä½¿å¿«å–ç„¡æ•ˆ |
