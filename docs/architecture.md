# 📚 GhostOS 核心架構設計書

## 目錄

1. [系統概述](#系統概述)
2. [記憶體佈局](#記憶體佈局)
3. [中斷處理表](#中斷處理表)
4. [程序調度](#程序調度)
5. [檔案系統](#檔案系統)

---

## 系統概述

GhostOS 是一個教學導向的作業系統研究專案，旨在透過邏輯分析和文檔整理來理解現代作業系統的核心概念。

### 設計原則

1. **最小化複雜度**：只關注核心概念
2. **自底向上**：從硬體開始，逐層理解
3. **驗證導向**：每個概念都有對應的邏輯驗證

---

## 記憶體佈局

### 實體記憶體映射 (x86 PC)

```
0x00000000 ┌─────────────────────────────┐
           │     Real Mode IVT          │  1 KB
0x00000400 ├─────────────────────────────┤
           │     BIOS Data Area         │  256 bytes
0x00000500 ├─────────────────────────────┤
           │     Free (可用區域)         │  约 30 KB
0x00007C00 ├─────────────────────────────┤
           │     Bootloader (MBR)       │  512 bytes
0x00007E00 ├─────────────────────────────┤
           │     Free (可用區域)         │
0x0009FC00 ├─────────────────────────────┤
           │     Extended BIOS Data     │  ~1 KB
0x000A0000 ├─────────────────────────────┤
           │     Video Memory           │  128 KB
0x000C0000 ├─────────────────────────────┤
           │     Video BIOS             │  32 KB
0x000C8000 ├─────────────────────────────┤
           │     BIOS Expansions        │
0x000F0000 ├─────────────────────────────┤
           │     System BIOS            │  64 KB
0x00100000 ├─────────────────────────────┤
           │     Extended Memory        │  ← 這裡開始放 Kernel
           │     (可用於 OS)            │
           │                            │
           │     ...                    │
           │                            │
0xFFFFFFFF └─────────────────────────────┘
```

### Kernel 記憶體佈局

```
0x00100000 ┌─────────────────────────────┐
           │     Kernel Code (.text)    │
           ├─────────────────────────────┤
           │     Kernel Data (.data)    │
           ├─────────────────────────────┤
           │     Kernel BSS (.bss)      │
           ├─────────────────────────────┤
           │     Kernel Heap            │
           ├─────────────────────────────┤
           │     Page Tables            │
           ├─────────────────────────────┤
           │     Kernel Stack(s)        │
           └─────────────────────────────┘
```

---

## 中斷處理表

### x86 中斷向量表

| 向量號 | 類型 | 名稱 | 描述 |
|--------|------|------|------|
| 0 | Fault | #DE | 除法錯誤 |
| 1 | Fault/Trap | #DB | 調試異常 |
| 2 | Interrupt | NMI | 非遮蔽中斷 |
| 3 | Trap | #BP | 斷點 |
| 4 | Trap | #OF | 溢出 |
| 5 | Fault | #BR | 邊界範圍超出 |
| 6 | Fault | #UD | 無效指令 |
| 7 | Fault | #NM | 設備不可用 |
| 8 | Abort | #DF | 雙重錯誤 |
| 10 | Fault | #TS | 無效 TSS |
| 11 | Fault | #NP | 段不存在 |
| 12 | Fault | #SS | 堆疊段錯誤 |
| 13 | Fault | #GP | 一般保護錯誤 |
| 14 | Fault | #PF | 頁面錯誤 |
| 16 | Fault | #MF | x87 FPU 錯誤 |
| 17 | Fault | #AC | 對齊檢查 |
| 18 | Abort | #MC | 機器檢查 |
| 19 | Fault | #XM | SIMD 異常 |
| 32-255 | | | 使用者定義 (IRQ, syscall 等) |

### 硬體 IRQ 映射

| IRQ | 中斷向量 | 設備 |
|-----|----------|------|
| 0 | 32 | PIT (可程式間隔計時器) |
| 1 | 33 | 鍵盤 |
| 2 | 34 | 級聯 (連接到 Slave PIC) |
| 3 | 35 | COM2 |
| 4 | 36 | COM1 |
| 5 | 37 | LPT2 |
| 6 | 38 | 軟碟 |
| 7 | 39 | LPT1 / 虛假中斷 |
| 8 | 40 | CMOS 時鐘 |
| 12 | 44 | PS/2 滑鼠 |
| 13 | 45 | FPU 協處理器 |
| 14 | 46 | 主 ATA |
| 15 | 47 | 副 ATA |

---

## 程序調度

### 程序狀態

```
           ┌───────────┐
           │   NEW     │
           └─────┬─────┘
                 │ admit
                 ▼
           ┌───────────┐         ┌───────────┐
     ┌─────│   READY   │◄────────│  WAITING  │
     │     └─────┬─────┘ I/O done└───────────┘
     │           │                     ▲
     │  dispatch │                     │ I/O request
     │           ▼                     │
     │     ┌───────────┐               │
     │     │  RUNNING  │───────────────┘
     │     └─────┬─────┘
     │           │
     │  preempt  │ exit
     │           ▼
     │     ┌───────────┐
     └────►│TERMINATED │
           └───────────┘
```

### 調度算法概述

| 算法 | 優點 | 缺點 |
|------|------|------|
| FCFS | 簡單 | 可能造成護航效應 |
| SJF | 最小平均等待時間 | 需要預知執行時間 |
| Priority | 可處理優先級 | 可能飢餓 |
| Round Robin | 公平、響應快 | 上下文切換開銷 |
| MLFQ | 平衡吞吐量和響應 | 實現複雜 |

---

## 檔案系統

### 簡化的 VFS 層次結構

```
┌──────────────────────────────────────────────────┐
│                  應用程式                         │
│              open(), read(), write()             │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│               系統調用介面                        │
│            sys_open, sys_read, sys_write         │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│              VFS (Virtual File System)           │
│     inode, dentry, file, superblock 抽象層       │
└──────────────────────┬───────────────────────────┘
                       │
       ┌───────────────┼───────────────┐
       ▼               ▼               ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│    ext4     │ │    FAT32    │ │   tmpfs     │
└──────┬──────┘ └──────┬──────┘ └──────┬──────┘
       │               │               │
       ▼               ▼               ▼
┌──────────────────────────────────────────────────┐
│                  Block Layer                      │
└──────────────────────┬───────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│                  Device Driver                    │
└──────────────────────────────────────────────────┘
```

---

## 後續章節

- [啟動流程詳解](../boot/bootloader_logic.md)
- [記憶體分頁機制](memory_management.md)
- [系統調用實現](../kernel/syscall_flow.md)
