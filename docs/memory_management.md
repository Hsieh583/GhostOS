# 📖 記憶體管理詳解 (Memory Management)

## 概述

記憶體管理是作業系統最核心的功能之一。本文檔詳細分析虛擬記憶體、分頁機制和記憶體分配策略。

---

## 1. 為什麼需要虛擬記憶體?

### 問題

- 程式需要連續的記憶體空間
- 實體記憶體有限且碎片化
- 多個程式需要同時運行
- 程式之間需要隔離保護

### 解決方案

虛擬記憶體提供：
1. **地址空間隔離**：每個程序看到獨立的地址空間
2. **按需分配**：只分配實際使用的記憶體
3. **記憶體保護**：防止程序互相干擾
4. **共享機制**：允許共享庫和記憶體映射

---

## 2. 分頁機制 (Paging)

### 基本概念

```
虛擬地址空間                    實體記憶體
┌───────────────┐               ┌───────────────┐
│   Page 0      │──────────────►│   Frame 5     │
├───────────────┤               ├───────────────┤
│   Page 1      │──────────────►│   Frame 2     │
├───────────────┤               ├───────────────┤
│   Page 2      │──────┐        │   Frame 0     │
├───────────────┤      │        ├───────────────┤
│   Page 3      │      └───────►│   Frame 7     │
├───────────────┤               ├───────────────┤
│     ...       │               │     ...       │
└───────────────┘               └───────────────┘
        │                               ▲
        └───────────────────────────────┘
              透過頁表 (Page Table) 映射
```

### 頁表項 (PTE) 結構

```
31                                           12 11        0
┌───────────────────────────────────────────────┬──────────┐
│           Frame Number (20 bits)              │  Flags   │
└───────────────────────────────────────────────┴──────────┘

Flags:
┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ G │ 0 │ D │ A │PCD│PWT│U/S│R/W│ P │AVL│AVL│AVL│
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
 11  10   9   8   7   6   5   4   3   2   1   0

P   = Present (1=頁面在記憶體中)
R/W = Read/Write (1=可寫入)
U/S = User/Supervisor (1=使用者模式可存取)
PWT = Page Write-Through
PCD = Page Cache Disable
A   = Accessed (CPU 設置)
D   = Dirty (頁面被修改過)
G   = Global (TLB 不刷新)
```

---

## 3. 多級頁表

### 為什麼需要多級頁表?

- 32-bit 地址空間 = 4 GB
- 4 KB 頁面 = 1M 個頁面
- 每個 PTE 4 bytes = 4 MB 頁表
- 每個程序都需要這麼大的頁表!

### 兩級頁表結構

```
          虛擬地址 (32 bits)
┌──────────┬──────────┬────────────┐
│ Dir (10) │Table (10)│Offset (12) │
└────┬─────┴────┬─────┴─────┬──────┘
     │          │           │
     │   ┌──────┘           │
     │   │                  │
     ▼   │                  │
┌────────────┐              │
│    CR3     │              │
└─────┬──────┘              │
      │                     │
      ▼                     │
┌───────────────┐           │
│ Page Directory│           │
│ (1024 entries)│           │
└───────┬───────┘           │
        │                   │
        ▼                   │
┌───────────────┐           │
│  Page Table   │           │
│ (1024 entries)│           │
└───────┬───────┘           │
        │                   │
        ▼                   │
┌───────────────┐◄──────────┘
│Physical Page  │  + Offset
│   (4 KB)      │
└───────────────┘
```

---

## 4. TLB (Translation Lookaside Buffer)

### 工作原理

```
          ┌─────────────────────────────────────┐
          │              CPU                     │
          │   ┌─────────────────────────────┐   │
          │   │     虛擬地址: 0x12345678     │   │
          │   └───────────────┬─────────────┘   │
          │                   │                 │
          │                   ▼                 │
          │   ┌───────────────────────────┐     │
          │   │          TLB              │     │
          │   │  VA Page → PA Frame       │     │
          │   │  ────────────────────     │     │
          │   │  0x12345 → 0xABCDE        │     │
          │   │  0x67890 → 0x11111        │     │
          │   │  ...                      │     │
          │   └───────────────┬───────────┘     │
          │         Hit? │   │ Miss             │
          │              ▼   ▼                  │
          │         ┌────────────────┐          │
          │         │  Page Table    │          │
          │         │  Walk (慢)     │          │
          │         └────────────────┘          │
          └─────────────────────────────────────┘
                         │
                         ▼
          ┌─────────────────────────────────────┐
          │      實體地址: 0xABCDE678           │
          └─────────────────────────────────────┘
```

### TLB 命中率重要性

| TLB 命中率 | 平均存取時間 |
|------------|-------------|
| 99% | ~101 cycles |
| 95% | ~105 cycles |
| 90% | ~110 cycles |
| 50% | ~150 cycles |

(假設 TLB 命中 = 1 cycle, 頁表查找 = 100 cycles)

---

## 5. Page Fault 處理

### 觸發條件

1. 頁面不存在 (P = 0)
2. 權限違規 (存取沒有權限的頁面)
3. 保留位元被設置

### 處理流程

```
┌─────────────────────────────────────────────┐
│            CPU 存取虛擬地址                  │
└──────────────────────┬──────────────────────┘
                       │
                       ▼
              ┌──────────────────┐
              │  TLB 查詢        │
              └────────┬─────────┘
                       │ Miss
                       ▼
              ┌──────────────────┐
              │  Page Table Walk │
              └────────┬─────────┘
                       │ P = 0
                       ▼
         ┌─────────────────────────────┐
         │     CPU 產生 #PF 異常       │
         │  • 保存 faulting address    │
         │    到 CR2 暫存器            │
         │  • 保存錯誤碼到堆疊         │
         └─────────────┬───────────────┘
                       │
                       ▼
         ┌─────────────────────────────┐
         │      OS Page Fault Handler  │
         └─────────────┬───────────────┘
                       │
          ┌────────────┴────────────┐
          │    分析 faulting        │
          │    address 和錯誤碼     │
          └────────────┬────────────┘
                       │
    ┌──────────────────┼──────────────────┐
    │                  │                  │
    ▼                  ▼                  ▼
┌────────┐      ┌────────────┐      ┌────────┐
│Invalid │      │Valid Fault │      │CoW     │
│Access  │      │(需載入頁面) │      │Fault   │
└────┬───┘      └─────┬──────┘      └───┬────┘
     │                │                 │
     ▼                ▼                 ▼
┌────────┐      ┌────────────┐      ┌────────┐
│SIGSEGV │      │分配Frame   │      │複製頁面│
│終止程式│      │載入內容    │      │更新PTE │
└────────┘      │更新PTE     │      └────────┘
                └────────────┘
```

### 錯誤碼格式

| 位元 | 說明 |
|------|------|
| 0 (P) | 0 = 頁面不存在, 1 = 保護違規 |
| 1 (W/R) | 0 = 讀取造成, 1 = 寫入造成 |
| 2 (U/S) | 0 = 核心模式, 1 = 使用者模式 |
| 3 (RSVD) | 1 = 保留位元違規 |
| 4 (I/D) | 1 = 指令提取造成 |

---

## 6. 記憶體分配器

### Buddy System

```
初始狀態: 一個 64 KB 區塊
┌────────────────────────────────────────────────────────────────┐
│                           64 KB                                 │
└────────────────────────────────────────────────────────────────┘

請求 8 KB:
┌───────────────────────────────┬───────────────────────────────┐
│            32 KB              │            32 KB               │
├───────────────┬───────────────┤
│    16 KB      │    16 KB      │
├───────┬───────┤
│ 8 KB  │ 8 KB  │
├───────┤
│ Used  │
└───────┘

釋放後合併:
┌────────────────────────────────────────────────────────────────┐
│                           64 KB (空閒)                          │
└────────────────────────────────────────────────────────────────┘
```

### Slab Allocator

```
┌─────────────────────────────────────────────┐
│              Slab Cache                      │
│         (e.g., task_struct cache)           │
├─────────────────────────────────────────────┤
│                                             │
│    Slab 1 (Full)      Slab 2 (Partial)     │
│    ┌───────────┐      ┌───────────┐        │
│    │ [Object]  │      │ [Object]  │        │
│    │ [Object]  │      │ [  Free ] │        │
│    │ [Object]  │      │ [Object]  │        │
│    │ [Object]  │      │ [  Free ] │        │
│    └───────────┘      └───────────┘        │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 7. 關鍵暫存器

| 暫存器 | 用途 |
|--------|------|
| CR0 | 控制分頁啟用 (PG 位元) |
| CR2 | 保存 Page Fault 地址 |
| CR3 | 頁目錄物理基址 |
| CR4 | 控制分頁擴展功能 (PAE, PSE 等) |

### 啟用分頁

```asm
; 設置 CR3 (頁目錄基址)
mov eax, page_directory
mov cr3, eax

; 啟用分頁 (設置 CR0.PG)
mov eax, cr0
or  eax, 0x80000000
mov cr0, eax

; 現在處於分頁模式!
```

---

## 參考資料

- Intel® 64 and IA-32 Architectures Software Developer's Manual, Volume 3A, Chapter 4
- [OSDev Wiki - Paging](https://wiki.osdev.org/Paging)
- [Linux Kernel - Memory Management](https://www.kernel.org/doc/html/latest/mm/)
